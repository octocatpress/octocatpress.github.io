# 事务

TCL: Transaction Control Language 事务控制语言
事务：一个或一组sql语句组成一个执行单元，这个执行单元要么全部执行，要么全部不执行。

案例：转账

事务详细概念：
事务由单独单元的一个或多个sql语句组成，在这个单元中，每个mysql语句是相互依赖的。而整个单独单元作为一个不可分割的整体，如果单元中某条sql语句一旦执行失败或者产生错误，整个单元将会回滚。所有受到影响的数据将返回到事务开始以前的状态，如果单元中的所有sql语句均执行成功，则事务被顺利执行。



在mysql中的数据用各种不同的技术存储在文件（或内存)中。
通过show engines; 来查看mysql支持的存储引擎。
在mysql中用的最多的存储引擎有：innodb,myisam,memory等，其中innodb支持事务，其余两个不支持。


事务的ACID属性

- 原子性（Atomicity)
原子性是指事务是一个（不可分割）的（最小）作单位，事务中的操作要么都发生，要么都不发生。
- 一致性（Consistency)
事务必须使数据库从一个一致性状态变换到另外一个一致性状态
- 隔离性（Isolation）
事务的隔离性是指一个事物的执行不能被其他事务干扰，即一个事务内部的操作及使用的数据对并发的其他事务是隔离的，并发执行的各个事务之间不能互相干扰。
- 持久性（Durability）
持久性是指一个事务一旦被提交，它对数据库中的数据的改变就是永久性的，接下来的其他操作和数据库故障不应该对其有任何影响。

## 事务的创建
隐式事务：事务没有明显的开启和结束的标记
比如insert，update，delete语句（这些语句每一条都是一个事务，具有自动提交功能）


显式事务：事务具有明显的开启和结束标记
前提：必须先设置自动提交功能为禁用。
``` sql
set autocommit=0;  // 只对当前的会话有效，所以每次都需要手动更改一下
show variables like 'autocommit';
```

步骤：
1. 开启事务

set autocommit=0;
start transaction; # 可选的

2. 编写事务中的sql语句（select，insert，update，delete）
语句1;
语句2;
...

3. 结束事务
commit; # 提交事务
rollback; # 回滚事务

在结束事务之前，数据可以理解为只保存在了内存里，并没有提交到磁盘文件，真正提交事务，才决定是提交到磁盘文件还是撤销。
也就是只有了结束的标记才能决定撤销还是提交到磁盘文件。


### 数据库的隔离级别
对于同时运行多个事务，当这些事务访问**数据库中相同的数据**时，如果没有采取必要的隔离机制，就会导致各种并发问题。
- 脏读：对于两个事务T1,T2,T1读取了已经被T2更新但还没有被提交的字段；之后，若T2回滚，T1读取的内容就是临时且无效的。
- 不可重复读：对于两个事务T1,T2,T1读取了一个字段，然后T2更新了该字段，之后，T1再次读取同一个字段，值就不同了。
- 幻读：对于两个事务T1,T2，T1从一个表中读取了一个字段，然后T2在该表中插入/删除了一些新的行。之后，如果T1再次读取同一个表，就会多出几行。


数据库事务的隔离性：数据库系统必须具有隔离并发运行各个事务的能力，使他们不会相互影响，避免各种并发问题。


一个事务与其他事务隔离的程度称为隔离级别，数据库规定了多种事务隔离级别，不同隔离级别对应不同的干扰程度，隔离级别越高，数据一致性就越好，但并发性越弱。

数据库提供的4种隔离级别：

| 隔离级别 | 描述 |
| :----:| :----:  |
| READ UNCOMMITTED(读未提交数据)  | 允许事务读取未被其他事务提交的变更。脏读，不可重复读和幻读的问题都会出现 |
| READ COMMITED(读已提交数据)  | 只允许事务读取已经被其他事务提交的变更。可以避免脏读，但不可重复读和幻读问题仍然可能出现 |
| REPEATABLE READ(可重复读) | 确保事务可以多次从一个字段中读取相同的值，在这个事务持续期间。禁止其他事务对这个字段进行更新，可以避免脏读和不可重复读，但幻读的问题仍然存在|
| SERIALIZABLE(串行化)| 确保事务可以从一个表中读取相同的行。在这个事务持续期间，禁止其他事务对该表执行插入，更新和删除操作。所以并发问题都可以避免，但性能十分低下 |


- Oracle支持的2种事务隔离级别:READ COMMITED,SERIALIZABLE。Oracle默认的事务隔离级别：READ COMMITED
- MySQL支持4种事务隔离级别。MySQL默认的事务隔离接别为 REPEATABLE READ。

查看当前的隔离级别：
select @@transaction_isolation;

设置隔离级别为`READ UNCOMMITTED`

set session transaction isolation level read uncommited;
逐个翻译：设置会话事务隔离级别(为)读未提交数据



 